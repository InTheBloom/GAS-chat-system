<!DOCTYPE html>

<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>ログイン</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="/forum/utils.js"></script>
        <script src="/forum/variables.js"></script>
        <script src="/forum/thread.js"></script>

<script>
function display_current_info () {
    const current_user_name_frame = document.getElementById("current_user_name");
    const current_password_frame = document.getElementById("current_password");

    current_user_name_frame.innerHTML = localStorage.getItem("user");
    current_password_frame.innerHTML = localStorage.getItem("password");
}

async function is_user_name_collision (name) {
    const response = await fetch(gas_app_url, {
        method: "POST",
        body: JSON.stringify({
            type: "is-user-collision",
            data: {
                user_name: `${name}`,
            }
        })
    });

    const json = await response.json();

    if (json.verdict === "ERROR") {
        throw new Error(`${json.detail}`);
    }

    return json.detail === "true";
}

async function login () {
    const user_name_input = document.getElementById("user_name");
    const password_input = document.getElementById("password");

    const user_name = escapeHtml(user_name_input.value);
    const password = password_input.value;

    if (user_name === "") {
        alert("ユーザー名が空です。");
        return;
    }
    if (password === "") {
        alert("パスワードが空です。");
    }

    // 情報のフェッチ
    let collision;
    try {
        collision = await is_user_name_collision(user_name);
    }
    catch (e) {
        alert(`エラーが発生しました。 Error: ${e}`);
        return;
    }

    if (collision) {
        if (!confirm(`ユーザ名: ${user_name}でログインを試みます。よろしいですか？`)) return;
    }
    else {
        if (!confirm(`ユーザ名: ${user_name}でアカウントを作成します。よろしいですか？`)) return;
    }

    // ログインクエリ
    const response = await fetch(gas_app_url, {
        method: "POST",
        body: JSON.stringify({
            type: "login",
            data: {
                user_name: `${user_name}`,
                password: `${password}`,
            }
        })
    });

    const json = await response.json();

    if (json.verdict === "ERROR") {
        alert(`エラーが発生しました。Error: ${json.detail}`);
        return;
    }

    alert(`成功しました。 Message: ${json.detail}`);

    // フォーム削除
    user_name_input.value = "";
    password_input.value = "";

    // LocalStorageに反映
    localStorage.setItem("user", user_name);
    localStorage.setItem("password", password);
}
</script>

<script>
/* Entry point */
function main () {
    if (!storageAvailable("localStorage")) {
        alert("localStorageが利用できません。");
        return;
    }

    display_current_info();

    document.getElementById("verify_btn").addEventListener("click", async () => { await login(); display_current_info(); });
};

document.addEventListener("DOMContentLoaded", () => main());
</script>
    </head>

    <body>
        <h1>ログインフォーム</h1>

        <h2>現在のログイン情報</h2>
        <div>
            <p>ユーザ名: <span id="current_user_name"></span></p>
            <p>パスワード: <span id="current_password"></span></p>
        </div>

        <h2>ログイン/サインイン</h2>
        <label for="user_name">ユーザ名</label>
        <input type="text" name="user_name" id="user_name">
        <label for="password">パスワード</label>
        <input type="text" name="password" id="password">
        <button id="verify_btn">ログイン/サインイン</button>
    </body>
</html>
