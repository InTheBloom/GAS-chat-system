<!DOCTYPE html>

<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>掲示板(笑)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="/src/utils.js"></script>
        <script src="/src/variables.js"></script>
        <script src="/src/request.js"></script>

<script>
async function fetch_and_display_thread () {
    try {
        await fetch_all_thread();
    }
    catch (e) {
        alert(e);
        return;
    }
    display_thread();
}

function display_thread () {
    // localStorageのデータをhtmlへ反映
    const viewer = document.getElementById("viewer");
    viewer.innerHTML = "";

    const all_thread = (() => {
        if (!localStorage.hasOwnProperty("all_thread")) {
            return [];
        }
        return JSON.parse(localStorage.getItem("all_thread"))
    })().sort((a, b) => {
        const dA = new Date(a.updated_at);
        const dB = new Date(b.updated_at);
        return dB - dA;
    });
    for (const thread of all_thread) {
        viewer.innerHTML += `
            <a href="thread/?title=${thread.title}" style="text-decoration: none;">
            <div style="
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                margin: 10px 0;
                background-color: #f9f9f9;
                box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
                font-family: Arial, sans-serif;
            ">
            <div style="font-size: 1.2em; font-weight: bold; color: #333;">
                ${thread.title}
            </div>
            <div style="margin-top: 5px; color: #555;">
            <span style="font-weight: bold;">Creator:</span> ${thread.creator}
            </div>
            <div style="margin-top: 5px; color: #777;">
            <span style="font-weight: bold;">Last Update:</span> ${thread.updated_at}
            </div>
            </div>
            </a>
            `;
    }
}

function try_update_thread () {
    // 前回起動から5分以上時間があいていれば更新
    const interval_ms = 1000 * 60 * 5;
    if (Date.now() - parseInt(localStorage.getItem("last_thread_updated")) < interval_ms) {
        return;
    }
    localStorage.setItem("last_thread_updated", `${Date.now()}`);
    fetch_and_display_thread();
}
</script>

<script>
/* Entry point */
function main () {
    if (!storageAvailable("localStorage")) {
        alert("掲示板を利用するにはlocalStorageが有効である必要があります。");
        return;
    }

    // ボタンを押す -> スレッド作成
    const btn = document.getElementById("create_thread_btn");
    btn.addEventListener("click", async () => {
        const title_input = document.getElementById("thread_title");
        const title = escapeHtml(title_input.value).trim();
        title_input.value = "";
        try {
            await create_new_thread(title);
        }
        catch (e) {
            alert(e);
            return;
        }
        fetch_and_display_thread();
    });

    // localStorage保存分を表示
    display_thread();

    // スレッド自動更新トリガ
    try_update_thread();
    setInterval(() => {
        try_update_thread();
    }, 1000 * 5);
};

document.addEventListener("DOMContentLoaded", () => main());
</script>
    </head>

    <body>
        <h1>掲示板(仮)</h1>

        <h2>新しいスレッドを作成する</h2>
        <label for="thread_title">スレッド名</label>
        <input type="text" name="thread_title" id="thread_title">
        <button id="create_thread_btn">スレッドを作成</button>

        <hr>

        <h2>スレッド一覧(新着順)</h2>
        <div id="viewer"></div>
    </body>
</html>
